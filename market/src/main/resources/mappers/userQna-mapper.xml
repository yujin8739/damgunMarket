<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userQnaMapper">
    
    <resultMap id="userQnaResultSet" type="UserQnaInfo">
        <result column="USERQNA_NUM" property="userQnaNum"/>
        <result column="USER_NO" property="userNo"/>
        <result column="USERQNA_TITLE" property="userQnaTitle"/>
        <result column="USERQNA" property="userQna"/>
        <result column="EXUSER_NUM" property="exuserNum"/> 
        <result column="USERQNA_IMG" property="userQnaImg"/>
    </resultMap>
    
    <select id="selectUserQnaList" resultMap="userQnaResultSet">
        SELECT * FROM USERQNA_INFO ORDER BY USERQNA_NUM DESC
    </select>
    
    <select id="selectUserQna" parameterType="_int" resultMap="userQnaResultSet">
        SELECT * FROM USERQNA_INFO WHERE USERQNA_NUM = #{userQnaNum}
    </select>
    
    <!-- INSERT 문 수정: 시퀀스 처리 개선 -->
    <insert id="insertUserQna" parameterType="UserQnaInfo">
        <selectKey keyProperty="userQnaNum" resultType="int" order="BEFORE">
            SELECT USERQNA_NUM_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO USERQNA_INFO (
            USERQNA_NUM, 
            USER_NO, 
            USERQNA_TITLE, 
            USERQNA, 
            <if test="userQnaImg != null and userQnaImg != ''">
            USERQNA_IMG,
            </if>
            <if test="exuserNum != null and exuserNum > 0">
            EXUSER_NUM
            </if>
        ) VALUES (
            #{userQnaNum}, 
            #{userNo}, 
            #{userQnaTitle}, 
            #{userQna}
            <if test="userQnaImg != null and userQnaImg != ''">
            , #{userQnaImg}
            </if>
            <if test="exuserNum != null and exuserNum > 0">
            , #{exuserNum}
            </if>
        )
    </insert>
    
    <!-- UPDATE 문 수정: 동적 SQL 사용 -->
    <update id="updateUserQna" parameterType="UserQnaInfo">
        UPDATE USERQNA_INFO SET 
            USERQNA_TITLE = #{userQnaTitle},
            USERQNA = #{userQna}
            <if test="userQnaImg != null and userQnaImg != ''">
            , USERQNA_IMG = #{userQnaImg}
            </if>
        WHERE USERQNA_NUM = #{userQnaNum}
    </update>
    
    <delete id="deleteUserQna" parameterType="_int">
        DELETE FROM USERQNA_INFO WHERE USERQNA_NUM = #{userQnaNum}
    </delete>
    
    <select id="selectUserQnaByUser" parameterType="_int" resultMap="userQnaResultSet">
        SELECT * FROM USERQNA_INFO WHERE USER_NO = #{userNo} ORDER BY USERQNA_NUM DESC
    </select>
    
    <select id="selectReportQna" parameterType="_int" resultMap="userQnaResultSet">
        SELECT * FROM USERQNA_INFO WHERE EXUSER_NUM = #{exuserNum} ORDER BY USERQNA_NUM DESC
    </select>
    
    <select id="searchUserQna" parameterType="string" resultMap="userQnaResultSet">
        SELECT * FROM USERQNA_INFO 
        WHERE USERQNA_TITLE LIKE '%'||#{keyword}||'%' 
           OR USERQNA LIKE '%'||#{keyword}||'%'
        ORDER BY USERQNA_NUM DESC
    </select>
    
    <select id="selectLatestUserQnaNum" parameterType="_int" resultType="java.lang.Integer">
        SELECT NVL(MAX(USERQNA_NUM), 0)
        FROM USERQNA_INFO 
        WHERE USER_NO = #{userNo}
    </select>
</mapper>