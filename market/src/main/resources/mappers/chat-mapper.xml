<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">

    <!-- ChatRoom 매핑 -->
    <resultMap id="chatRoomResultMap" type="com.kh.soak.chat.model.vo.ChatRoomVO">
        <id property="roomNo" column="ROOM_NO"/>
        <result property="userId" column="USER_ID"/>
        <result property="lastVisit" column="LASTVISIT"/>
        <result property="chatType" column="CHAT_TYPE"/>
    </resultMap>

    <!-- Message 매핑 -->
    <resultMap id="messageResultMap" type="com.kh.soak.chat.model.vo.MessageVO">
        <id property="no" column="NO"/>
        <result property="roomNo" column="ROOM_NO"/>
        <result property="message" column="MESSAGE"/>
        <result property="imageUrl" column="IMAGEURL"/>
        <result property="userId" column="USER_ID"/>
        <result property="sendTime" column="SENDTIME"/>
    </resultMap>

    <!-- 채팅방 번호 시퀀스 -->
    <select id="getNextChatRoomNo" resultType="_int">
        SELECT CHAT_ROOM_SEQ.NEXTVAL FROM DUAL
    </select>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom" parameterType="com.kh.soak.chat.model.vo.ChatRoomVO">
        INSERT INTO CHAT_ROOM (ROOM_NO, USER_ID, LASTVISIT, CHAT_TYPE)
        VALUES (
            #{roomNo},
            #{userId},
            <choose>
                <when test="lastVisit != null">
                    TO_CHAR(#{lastVisit}, 'YYYYMMDDHH24MISS')
                </when>
                <otherwise>
                    '0'
                </otherwise>
            </choose>,
            #{chatType}
        )
    </insert>

    <!-- 채팅방 번호로 단일 조회 -->
    <select id="selectChatRoomById" parameterType="_int" resultMap="chatRoomResultMap">
        SELECT ROOM_NO, USER_ID, LASTVISIT, CHAT_TYPE
        FROM CHAT_ROOM
        WHERE ROOM_NO = #{roomNo}
    </select>

    <!-- 특정 유저의 채팅방 목록 조회 -->
    <select id="selectChatRoomsByUserId" parameterType="string" resultMap="chatRoomResultMap">
        SELECT ROOM_NO, USER_ID, LASTVISIT, CHAT_TYPE
        FROM CHAT_ROOM
        WHERE USER_ID = #{userId}
        ORDER BY ROOM_NO DESC
    </select>

    <!-- 마지막 방문 시간 업데이트 -->
    <update id="updateLastVisit" parameterType="com.kh.soak.chat.model.vo.ChatRoomVO">
        UPDATE CHAT_ROOM
        SET LASTVISIT = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        WHERE ROOM_NO = #{roomNo}
        AND USER_ID = #{userId}
    </update>

    <!-- 메시지 저장 -->
    <insert id="insertMessage" parameterType="com.kh.soak.chat.model.vo.MessageVO">
        INSERT INTO MESSAGE (NO, ROOM_NO, MESSAGE, IMAGEURL, USER_ID, SENDTIME)
        VALUES (
            CHAT_MESSAGE_SEQ.NEXTVAL,
            #{roomNo},
            #{message},
            #{imageUrl},
            #{userId},
            SYSDATE
        )
    </insert>

    <!-- 특정 채팅방 메시지 목록 조회 -->
    <select id="selectMessagesByRoomNo" parameterType="_int" resultMap="messageResultMap">
        SELECT NO, ROOM_NO, MESSAGE, IMAGEURL, USER_ID, SENDTIME
        FROM MESSAGE
        WHERE ROOM_NO = #{roomNo}
        ORDER BY SENDTIME ASC
    </select>

</mapper>
